import React, { useState, useEffect } from "react";
import { useDispatch } from "react-redux";
import {
  acceptProposal,
  rejectProposal,
  getProposalsByProject,
} from "../../redux/features/proposalSlice";
import { getEmployerProjects } from "../../redux/features/projectSlice";
import { releaseFunds, refundFunds } from "../../redux/features/escrowSlice";
import style from "./ProposalList.module.scss";

const ProposalList = ({ projectId }) => {
  const dispatch = useDispatch();
  const [localProposals, setLocalProposals] = useState([]);

  useEffect(() => {
    const fetchProposals = async () => {
      try {
        const result = await dispatch(getProposalsByProject(projectId)).unwrap();
        setLocalProposals(result);
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∫–ª–∏–∫–æ–≤:", err);
      }
    };

    fetchProposals();
  }, [dispatch, projectId]);

  const handleAccept = (proposalId) => {
    dispatch(acceptProposal({ proposalId }))
      .unwrap()
      .then(({ proposal: updated }) => {
        const updatedList = localProposals.map((p) =>
          p._id === updated._id ? { ...updated } : { ...p, status: "rejected" }
        );
        setLocalProposals(updatedList);
        dispatch(getEmployerProjects());
      })
      .catch((err) => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –æ—Ç–∫–ª–∏–∫–∞:", err);
        alert("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–Ω—è—Ç—å –æ—Ç–∫–ª–∏–∫");
      });
  };

  const handleReleaseFunds = (proposal) => {
    const escrow = proposal.project?.escrow;
    if (!escrow || escrow.status !== "funded") return;

    dispatch(releaseFunds(escrow._id))
      .unwrap()
      .then((updatedEscrow) => {
        const updatedList = localProposals.map((p) => {
          if (p.project?.escrow?._id === updatedEscrow.escrow._id) {
            return {
              ...p,
              project: {
                ...p.project,
                escrow: { ...escrow, status: "released" },
              },
              status: "released",
            };
          }
          return p;
        });
        setLocalProposals(updatedList);
      })
      .catch((err) => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ —Å—Ä–µ–¥—Å—Ç–≤:", err);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –æ–ø–ª–∞—Ç—É");
      });
  };

  const handleRefund = (proposal) => {
    const escrow = proposal.project?.escrow;
    if (!escrow || escrow.status !== "funded") return;

    dispatch(refundFunds(escrow._id))
      .unwrap()
      .then((updatedEscrow) => {
        const updatedList = localProposals.map((p) => {
          if (p.project?.escrow?._id === updatedEscrow.escrow._id) {
            return {
              ...p,
              project: {
                ...p.project,
                escrow: { ...escrow, status: "refunded" },
              },
              status: "refunded",
            };
          }
          return p;
        });
        setLocalProposals(updatedList);
        alert("üí∞ –°—Ä–µ–¥—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—é");
      })
      .catch((err) => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ —Å—Ä–µ–¥—Å—Ç–≤:", err);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–µ—Ä–Ω—É—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞");
      });
  };

  return (
    <div className={style.proposalList}>
      {localProposals.length > 0 && <h4 className={style.heading}>–û—Ç–∫–ª–∏–∫–∏</h4>}
      {localProposals.length === 0 ? (
        <p className={style.noProposals}>–û—Ç–∫–ª–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
      ) : (
        localProposals
          .filter((proposal) => proposal.status !== "rejected")
          .map((proposal) => {
            const escrow = proposal.project?.escrow;

            return (
              <div key={proposal._id} className={style.proposalCard}>
                <div className={style.infoBlock}>
                  <p>
                    <strong>–§—Ä–∏–ª–∞–Ω—Å–µ—Ä:</strong>{" "}
                    {proposal.freelancer?.name || "–ë–µ–∑ –∏–º–µ–Ω–∏"}
                  </p>
                  <p>
                    <strong>–ü–∏—Å—å–º–æ:</strong> {proposal.coverLetter}
                  </p>
                  <p>
                    <strong>–¶–µ–Ω–∞:</strong> {proposal.price}‚ÇΩ
                  </p>
                  <p>
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> {proposal.status}
                  </p>
                </div>

                {proposal.status === "pending" && (
                  <div className={style.buttons}>
                    <button
                      className={style.acceptButton}
                      onClick={() => handleAccept(proposal._id)}
                    >
                      ‚úÖ –ü—Ä–∏–Ω—è—Ç—å
                    </button>
                    <button
                      className={style.rejectButton}
                      onClick={() => {
                        dispatch(rejectProposal({ proposalId: proposal._id }))
                          .unwrap()
                          .then(({ proposal: updated }) => {
                            const updatedList = localProposals.map((p) =>
                              p._id === updated._id
                                ? { ...p, status: updated.status }
                                : p
                            );
                            setLocalProposals(updatedList);
                          })
                          .catch((err) => {
                            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏:", err);
                            alert("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –æ—Ç–∫–ª–∏–∫");
                          });
                      }}
                    >
                      ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                    </button>
                  </div>
                )}

                {proposal.status === "submitted" && proposal.workFile && (
                  <div className={style.workBlock}>
                    <p>
                      <strong>–§—Ä–∏–ª–∞–Ω—Å–µ—Ä —Å–¥–∞–ª —Ä–∞–±–æ—Ç—É:</strong>
                    </p>
                    <a
                      href={`http://localhost:3000/api/proposals/download/${proposal.workFile}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className={style.downloadLink}
                    >
                      üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                    </a>

                    {escrow ? (
                      <>
                        {escrow.status === "funded" ? (
                          <div style={{ marginTop: 10 }}>
                            <button
                              className={style.acceptButton}
                              onClick={() => handleReleaseFunds(proposal)}
                            >
                              üí∏ –ü—Ä–∏–Ω—è—Ç—å —Ä–∞–±–æ—Ç—É –∏ –æ–ø–ª–∞—Ç–∏—Ç—å
                            </button>
                            <button
                              className={style.rejectButton}
                              onClick={() => handleRefund(proposal)}
                              style={{ marginLeft: "10px" }}
                            >
                              ‚õî –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∏ –≤–µ—Ä–Ω—É—Ç—å –¥–µ–Ω—å–≥–∏
                            </button>
                          </div>
                        ) : escrow.status === "refunded" ? (
                          <p style={{ color: "blue", marginTop: 10 }}>
                            üí∞ –°—Ä–µ–¥—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã
                          </p>
                        ) : (
                          <p style={{ color: "green", marginTop: 10 }}>
                            ‚úÖ –†–∞–±–æ—Ç–∞ –æ–ø–ª–∞—á–µ–Ω–∞
                          </p>
                        )}
                      </>
                    ) : (
                      <p style={{ color: "red", marginTop: 10 }}>
                        ‚ùó Escrow –Ω–µ –Ω–∞–π–¥–µ–Ω
                      </p>
                    )}
                  </div>
                )}
              </div>
            );
          })
      )}
    </div>
  );
};

export default ProposalList;
